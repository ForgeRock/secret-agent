---
apiVersion: secret-agent.secrets.forgerock.io/v1alpha1
kind: SecretAgentConfiguration
metadata:
  name: forgerock-sac
spec:
  appConfig:
    createKubernetesObjects: true
    secretsManager: none  # none, AWS, or GCP
    # credentialsSecretName: cloud-credentials
    # awsRegion: example-region
    # azureVaultName: example-vault
    # gcpProjectID: example-project
  secrets:
  - name: sms-transport-key
    keys:
      - name: sms.transport.key
        type: literal
        spec:
          isBase64: true
          value: |-
            zs7OzgAAAAIAAAABAAAAAwARc21zLnRyYW5zcG9ydC5rZXkAAAFrYlvb+aztAAVzcgAzY29tLnN1
            bi5jcnlwdG8ucHJvdmlkZXIuU2VhbGVkT2JqZWN0Rm9yS2V5UHJvdGVjdG9yzVfKWecwu1MCAAB4
            cgAZamF2YXguY3J5cHRvLlNlYWxlZE9iamVjdD42PabDt1RwAgAEWwANZW5jb2RlZFBhcmFtc3QA
            AltCWwAQZW5jcnlwdGVkQ29udGVudHEAfgACTAAJcGFyYW1zQWxndAASTGphdmEvbGFuZy9TdHJp
            bmc7TAAHc2VhbEFsZ3EAfgADeHB1cgACW0Ks8xf4BghU4AIAAHhwAAAAETAPBAh/uDZRKdXJMwID
            Aw1AdXEAfgAFAAAAkH8I1DxvzbYFI1ox/liF2rs098+4xco6htMHRuOaJcnwwp0iMAgS/fJa1PGT
            /X5v6BsTl2Zyb8gTUU+rbh8M31OktJU+z/Q55inwwTEznpbjm5qQ7hc1DKw3G25Q9sKRj4Ry4v3W
            rakmgK7f6tU3WPPlE3NWAemAtA5aZugtLGhXukzSuhN8e++J9xFLY1gijHQAFlBCRVdpdGhNRDVB
            bmRUcmlwbGVERVN0ABZQQkVXaXRoTUQ1QW5kVHJpcGxlREVT8US3JJhwcfIPGg4hp8rwH6I4gc8=
      - name: keypass
        type: literal
        spec:
          isBase64: true
          value: |-
            Y2hhbmdlaXQ=

      - name: storepass
        type: literal
        spec:
          isBase64: true
          value: |-
            MDdVK1pEeURxQlNZeTAwQStIdFVtdzhlU0h2SWp3SUU=

  - name: platform-ca
    keys:
      - name: ca
        type: ca
        spec:
          distinguishedName:
            commonName: "Deployment key"
            organization:
              - "ForgeRock.com"

  # this could be consolidated with the idm truststore, would need to change AM a bit
  - name: truststore
    keys:
      - name: cacerts
        type: truststore
        spec:
          # truststoreImportPaths: ["platform-ca/ca", "vault-secrets/vault-ca"]
          truststoreImportPaths: ["platform-ca/ca"]

  # DS secrets
  - name: ds-passwords
    keys:
      - name: dirmanager.pw
        type: password
        spec:
          length: 32
      - name: monitor.pw
        type: literal
        spec:
          value: prometheus

  - name: ds
    keys:
    - name: ssl-key-pair
      type: keyPair
      spec:
        algorithm: ECDSAWithSHA256
        distinguishedName:
          commonName: ds
          organization:
            - "ForgeRock.com"
        sans:
        - "*.ds"
        - "*.ds-idrepo"
        - "*.ds-cts"
        signedWithPath: "platform-ca/ca"
    - name: master-key-pair
      type: keyPair
      spec:
        algorithm: SHA256WithRSA
        distinguishedName:
          commonName: "Master key"
          organization:
            - "ForgeRock.com"
        selfSigned: true
        # any negative duration produces a certificate keypair that has
        # an unusable valid period and will be rejected by all PKI clients
        # this is a certificate used as a shared key between trusted applications
        # this certificate will have no extensions as well
        duration: "-72h"
    - name: keystore.pin
      type: password
      spec:
        length: 32
    - name: keystore
      type: keytool
      spec:
        storeType: pkcs12
        storePassPath: ds/keystore.pin
        keyPassPath: ds/keystore.pin
        keytoolAliases:
          - name: ca-cert
            cmd: importcert
            sourcePath: "platform-ca/ca"
          - name: ssl-key-pair
            cmd: importkeystore
            sourcePath: "ds/ssl-key-pair"
            isKeyPair: true
          - name: master-key
            cmd: importkeystore
            sourcePath: "ds/master-key-pair"
            isKeyPair: true
          - name: configstorepwd
            cmd: importpassword
            sourcePath: am-passwords/.storepass
            # sourcePath: "ds-passwords/tmpdsameuserpwd"
          - name: dsameuserpwd
            cmd: importpassword
            sourcePath: "ds-passwords/dirmanager.pw"
  # AM secrets
  - name: am-env-secrets
    keys:
    - name: "AM_AUTHENTICATION_SHARED_SECRET"
      type: password
      spec:
        length: 24
        useBinaryCharacters: true
    - name: "AM_CONFIRMATION_ID_HMAC_KEY"
      type: password
      spec:
        length: 24
    - name: "AM_ENCRYPTION_KEY"
      type: password
      spec:
        length: 24
    - name: "AM_OIDC_CLIENT_SUBJECT_IDENTIFIER_HASH_SALT"
      type: password
      spec:
        length: 20
    - name: "AM_PASSWORDS_AMADMIN_CLEAR"
      type: password
      spec:
        length: 24
    - name: "AM_SELFSERVICE_LEGACY_CONFIRMATION_EMAIL_LINK_SIGNING_KEY"
      type: password
      spec:
        length: 24
    - name: "AM_SESSION_STATELESS_ENCRYPTION_KEY"
      type: password
      spec:
        length: 24
        useBinaryCharacters: true
    - name: "AM_SESSION_STATELESS_SIGNING_KEY"
      type: password
      spec:
        length: 24
        useBinaryCharacters: true
  - name: am-passwords
    keys:
    - name: .keypass
      type: password
      spec:
        length: 24
    - name: .storepass
      type: password
      spec:
        length: 24
    - name: username
      type: literal
      spec:
        value: amadmin
  - name: am-keystore
    keys:
    - name: keystore.jceks
      type: keytool
      spec:
        storeType: jceks
        storePassPath: am-passwords/.storepass
        keyPassPath: am-passwords/.keypass
        keytoolAliases:
        - name: rsajwtsigningkey
          cmd: genkeypair
          args: ["-keyalg", "RSA", "-keysize", "2048", "-sigalg", "SHA256WITHRSA", "-validity", "3650", "-dname", "CN=rsajwtsigningkey,O=ForgeRock,L=Bristol,ST=Bristol,C=UK"]
        - name: ec256test
          cmd: genkeypair
          args: ["-keyalg", "EC", "-keysize", "256", "-sigalg", "SHA256withECDSA", "-validity", "3650", "-dname", "CN=es256test,O=ForgeRock,L=Bristol,ST=Bristol,C=UK"]
        - name: es384test
          cmd: genkeypair
          args: ["-keyalg", "EC", "-keysize", "384", "-sigalg", "SHA256withECDSA", "-validity", "3650", "-dname", "CN=es384test,O=ForgeRock,L=Bristol,ST=Bristol,C=UK"]
        - name: es512test
          cmd: genkeypair
          args: ["-keyalg", "EC", "-keysize", "512", "-sigalg", "SHA256withECDSA", "-validity", "3650", "-dname", "CN=es512test,O=ForgeRock,L=Bristol,ST=Bristol,C=UK"]
        - name: selfserviceenctest
          cmd: genkeypair
          args: ["-keyalg", "RSA", "-keysize", "2048", "-sigalg", "SHA256WITHRSA", "-validity", "3650", "-dname", "CN=selfserviceenctest,O=ForgeRock,L=Bristol,ST=Bristol,C=UK"]
        - name: test
          cmd: genkeypair
          args: ["-keyalg", "RSA", "-keysize", "2048", "-sigalg", "SHA256WITHRSA", "-validity", "3650", "-dname", "CN=test,O=ForgeRock,L=Bristol,ST=Bristol,C=UK"]
        - name: hmacsigningtest
          cmd: genseckey
          args: ["-keyalg", "HMacSHA512", "-keysize", "512"]
        - name: selfservicesigntest
          cmd: genseckey
          args: ["-keyalg", "HMacSHA512", "-keysize", "256"]
        - name: directenctest
          cmd: genseckey
          args: ["-keyalg", "aes", "-keysize", "256"]
        - name: configstorepwd
          cmd: importpassword
          sourcePath: am-passwords/.storepass
        - name: dsameuserpwd
          cmd: importpassword
          sourcePath: ds-passwords/dirmanager.pw
        - name: sms.transport.key
          cmd: importkeystore
          sourcePath: "sms-transport-key/sms.transport.key"
          # keytool -importkeystore -destalias sms.transport.key -srcalias sms.transport.key -srcstoretype jceks -srckeystore sms-transport-key/sms-transport-key.jceks -srckeypass:file sms-transport-key/keypass -srcstorepass:file sms-transport-key/storepass -destkeystore /opt/gen/secrets/generic/am-keystore/keystore.jceks -deststoretype jceks -deststorepass zzggthedwwd4pegt1tth02drmxfbdw01 -destkeypass is4spw1bfagasmsc0gpgd2gwrgrzchz0
  # Amster secrets
  - name: amster-env-secrets
    keys:
      - name: IDM_PROVISIONING_CLIENT_SECRET
        type: password
        spec:
          length: 24
      - name: IDM_RS_CLIENT_SECRET
        type: password
        spec:
          length: 24
  - name: amster
    keys:
    - name: id_rsa
      type: ssh
  - name: ds-env-secrets
    keys:
      - name: AM_STORES_APPLICATION_PASSWORD
        type: password
        spec:
          length: 32
      - name: AM_STORES_CTS_PASSWORD
        type: password
        spec:
          length: 32
      - name: AM_STORES_USER_PASSWORD
        type: password
        spec:
          length: 32
  # IDM secrets
  - name: idm-env-secrets
    keys:
    - name: OPENIDM_ADMIN_PASSWORD
      type: password
      spec:
        length: 24
    - name: OPENIDM_KEYSTORE_PASSWORD
      type: password
      spec:
        length: 24
        #  - name: OPENIDM_REPO_PASSWORD
        #    type: password
        #    spec:
        #      length: 24
  - name: idm
    keys:
    - name: keystore.jceks
      type: keytool
      spec:
        storeType: jceks
        storePassPath: idm-env-secrets/OPENIDM_KEYSTORE_PASSWORD
        keyPassPath: idm-env-secrets/OPENIDM_KEYSTORE_PASSWORD
        keytoolAliases:
        - name: openidm-sym-default
          cmd: genseckey
          args: ["-keyalg", "aes", "-keysize", "128"]
        - name: openidm-jwtsessionhmac-key
          cmd: genseckey
          args: ["-keyalg", "HmacSHA256", "-keysize", "256"]
        - name: openidm-selfservice-key
          cmd: genseckey
          args: ["-keyalg", "aes", "-keysize", "128"]
        - name: server-cert
          cmd: genkeypair
          args: ["-keyalg", "RSA", "-keysize", "2048", "-sigalg", "SHA256WITHRSA", "-validity", "3650", "-dname", "CN=server-cert,O=ForgeRock,L=Bristol,ST=Bristol,C=UK"]
        - name: selfservice
          cmd: genkeypair
          args: ["-keyalg", "RSA", "-keysize", "2048", "-sigalg", "SHA256WITHRSA", "-validity", "3650", "-dname", "CN=selfservice,O=ForgeRock,L=Bristol,ST=Bristol,C=UK"]
        - name: openidm-localhost
          cmd: genkeypair
          args: ["-keyalg", "RSA", "-keysize", "2048", "-sigalg", "SHA256WITHRSA", "-validity", "3650", "-dname", "CN=openidm-localhost,O=ForgeRock,L=Bristol,ST=Bristol,C=UK"]
    - name: truststore
      type: truststore
      spec:
        # truststoreImportPaths: ["platform-ca/ca", "vault-secrets/vault-ca"]
        truststoreImportPaths: ["platform-ca/ca"]

   # eg. binary password
   #  - name: binary-password
   #    keys:
   #      - name: binpw
   #        type: password
   #        spec:
   #          length: 32
   #          useBinaryCharacters: true
